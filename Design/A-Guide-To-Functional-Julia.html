<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>A Guide To Functional Julia &#8212; Site-32  documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DSL" href="../DSL/index.html" />
    <link rel="prev" title="Design" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../guide.html">
          Site-32</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../github.html">GitHub</a></li>
                <li><a href="../PL/index.html">PL</a></li>
                <li><a href="index.html">Design</a></li>
                <li><a href="../DSL/index.html">DSL</a></li>
                <li><a href="../Others/index.html">Others</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../guide.html">Site-32 <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Site-32 Index Page</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiler/index.html">Compiler</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/RBNF.html">RBNF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/RBNFRBNF.html">RBNFRBNF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/Parserc.html">Parser Combinator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/完美的编译前端.html">完美的编译前端</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/非文法变换的左递归处理.html">非文法变换的左递归处理</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/LLAST.html">LLAST</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Compiler/LLk-2-LR1.html">LL(k) to LL(1)</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">A Guide To Functional Julia</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../DSL/index.html">DSL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../DSL/write-your-a-query-language-with-MLStyle.html">Write You A Query Language</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Fiction/index.html">Fiction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PL/index.html">Programming Language</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../PL/HKT.html">Higher Kinded Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PL/typeclass.html">Type Classes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PL/paper-reading-LHKP.html">Paper Reading: Lightweight-Higher-Kinded-Polymorphism</a></li>
<li class="toctree-l2"><a class="reference internal" href="../PL/HKT-typeclass-FSharp.html">Compelling Higher Kinded Types and Type Classes in F#</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Others/index.html">Others</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Sub-sections <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">A Guide To Functional Julia</a><ul>
<li><a class="reference internal" href="#first-class">First-Class</a></li>
<li><a class="reference internal" href="#polymorphisms-of-multiple-dispatch">Polymorphisms of Multiple Dispatch</a></li>
<li><a class="reference internal" href="#full-featured-macros">Full-Featured Macros</a><ul>
<li><a class="reference internal" href="#macro-function-from-ast-to-ast">Macro, Function from AST to AST</a></li>
<li><a class="reference internal" href="#scope-of-macro-and-hygienic-macro">Scope of Macro and Hygienic Macro</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/Design/A-Guide-To-Functional-Julia.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary">
  <li>
    <a href="index.html" title="Previous Chapter: Design"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Design</span>
    </a>
  </li>
  <li>
    <a href="../DSL/index.html" title="Next Chapter: DSL"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">DSL &raquo;</span>
    </a>
  </li>
<form action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        </div>
      </div>
    <div class="col-md-9 content">
      
  <div class="section" id="a-guide-to-functional-julia">
<h1>A Guide To Functional Julia<a class="headerlink" href="#a-guide-to-functional-julia" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://julialang.org/">Julia</a> is a multi-paradigm language which is purely dynamic but supports optional typing.</p>
<p>As the introduction of some basic constructs like <code class="docutils literal notranslate"><span class="pre">For-Loop</span></code>, <code class="docutils literal notranslate"><span class="pre">While-Loop</span></code> and <code class="docutils literal notranslate"><span class="pre">If-Else</span></code> and <code class="docutils literal notranslate"><span class="pre">Function</span></code> akin to
those of Python, R or MATLAB, Julia becomes simple and concise, and allows you to work fluently with a fraction of its language
features.</p>
<blockquote>
<div><img alt="../_images/4-langs.png" src="../_images/4-langs.png" />
</div></blockquote>
<p>Although People seldom focus on Julia’s language features other than its high performance(until April 2019), I’d show my point
of view of the true functional programming in Julia.</p>
<div class="section" id="first-class">
<h2>First-Class<a class="headerlink" href="#first-class" title="Permalink to this headline">¶</a></h2>
<p>Almost all language constructs in Julia are <em>first-class</em>, upholding more flexible and advanced program composition.</p>
<p>There’re quite a lot of people that has a prejudice against Python for the absense of multi-line lambdas. Although
it’s pretty trivial and straightforward to compile multi-line lambdas into normal Python code objects, the frontend,
more concretely the mandatory indentation, comfines Python to the expressive power where statements are rigidly separate
from expressions and then <em>first-class</em> misses.</p>
<p>Julia seems to be over-<em>first-class</em>, for all constructs there are expressions and, syntactically there’s no
restriction to compose arbitrary constructs. Definitions and computations are distinct from each other in major
functional languages, but each of both consists of the other.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span> <span class="p">[</span><span class="k">let</span> <span class="n">y</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">end</span> <span class="k">for</span> <span class="n">x</span> <span class="kp">in</span> <span class="n">points</span><span class="p">]</span>

 <span class="n">map</span><span class="p">(</span>
   <span class="k">function</span> <span class="n">map_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
     <span class="c"># do stuffs</span>
   <span class="k">end</span><span class="p">,</span>
   <span class="n">points</span>
<span class="p">)</span>


<span class="k">let</span> <span class="n">bind_maybe</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">==</span> <span class="nb">nothing</span> <span class="o">?</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">:</span> <span class="nb">nothing</span><span class="p">,</span>
    <span class="p">(</span><span class="o">|&gt;</span><span class="p">)</span> <span class="o">=</span> <span class="n">bind_maybe</span>

    <span class="n">init</span>          <span class="o">|&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span>
    <span class="n">do1_stuffs</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span>
    <span class="o">...</span>           <span class="o">|&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span>
    <span class="o">...</span>           <span class="o">|&gt;</span> <span class="n">a</span> <span class="o">-&gt;</span>
    <span class="o">...</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="polymorphisms-of-multiple-dispatch">
<h2>Polymorphisms of Multiple Dispatch<a class="headerlink" href="#polymorphisms-of-multiple-dispatch" title="Permalink to this headline">¶</a></h2>
<p>Julia supports polymorphisms to achieve necessary abstractions and reduce self-repeating, though it
does stand apart from those pooular industrial languages.</p>
<p>Multiple dispatch looks like parametric polymorphism, but actually it’s more than the latter.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">usum</span><span class="p">(</span><span class="n">x</span> <span class="o">::</span> <span class="kt">Vector</span><span class="p">{</span><span class="n">T</span><span class="p">})</span> <span class="n">where</span> <span class="n">T</span>
   <span class="n">s</span> <span class="o">=</span> <span class="n">zero</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
   <span class="k">for</span> <span class="n">each</span> <span class="kp">in</span> <span class="n">x</span>
      <span class="n">s</span> <span class="o">+=</span> <span class="n">each</span>
   <span class="k">end</span>
   <span class="n">s</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Overloading is supported as well.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">uzero</span><span class="p">(</span><span class="n">_</span> <span class="o">::</span> <span class="kt">Type</span><span class="p">{</span><span class="kt">Int</span><span class="p">})</span>     <span class="o">=</span> <span class="mi">0</span>
<span class="n">uzero</span><span class="p">(</span>  <span class="o">::</span> <span class="kt">Type</span><span class="p">{</span><span class="kt">Float64</span><span class="p">})</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>However, multiple dispatch is more than what I listed above. In fact, type is exclusively
a specialized instance of immutable data, while you can make dispatches via immutable data
no matter whether it is a type or others.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">Const</span><span class="p">{</span><span class="n">T</span><span class="p">}</span>
<span class="k">end</span>

<span class="n">flip</span><span class="p">(</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">even</span><span class="p">}})</span> <span class="o">=</span> <span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">odd</span><span class="p">}</span>
<span class="n">flip</span><span class="p">(</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">odd</span><span class="p">}})</span>  <span class="o">=</span> <span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">even</span><span class="p">}</span>

<span class="n">f</span><span class="p">(</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="mi">0</span><span class="p">}})</span> <span class="o">=</span> <span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">even</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="mi">1</span><span class="p">}})</span> <span class="o">=</span> <span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">odd</span><span class="p">}</span>
<span class="n">f</span><span class="p">(</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="n">N</span><span class="p">}})</span> <span class="n">where</span> <span class="n">N</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">Const</span><span class="p">{</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">})</span> <span class="o">|&gt;</span> <span class="n">flip</span>
</pre></div>
</div>
<p>With above codes, we can statically compute parity of numbers, just as expected.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">julia</span><span class="o">&gt;</span> <span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="n">Const</span><span class="p">{</span><span class="mi">2</span><span class="p">})</span>

<span class="n">Body</span><span class="o">::</span><span class="kt">Type</span><span class="p">{</span><span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">even</span><span class="p">}}</span>
  <span class="mi">1</span> <span class="n">─</span>     <span class="k">return</span> <span class="n">Const</span><span class="p">{</span><span class="o">:</span><span class="n">even</span><span class="p">}</span>
</pre></div>
</div>
<p>Note that when multiple dispatch fails at static inferences, it’ll behave as dynamic dispatch like Python’s.</p>
</div>
<div class="section" id="full-featured-macros">
<h2>Full-Featured Macros<a class="headerlink" href="#full-featured-macros" title="Permalink to this headline">¶</a></h2>
<p>Macro is one of the quite few ways to achieve code reuse, also the reason of why
some programmer can be thousands of times more efficient than others.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">julia</span><span class="o">&gt;</span> <span class="k">macro</span> <span class="n">gen_var</span><span class="p">(</span><span class="n">n</span> <span class="o">::</span> <span class="kt">Int</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
       <span class="n">defs</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Expr</span><span class="p">(</span><span class="o">:</span><span class="p">(</span><span class="o">=</span><span class="p">),</span> <span class="kt">Symbol</span><span class="p">(</span><span class="s">&quot;var&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="o">:</span><span class="p">(</span><span class="o">$</span><span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">i</span><span class="p">)))</span>  <span class="k">for</span> <span class="n">i</span> <span class="kp">in</span> <span class="mi">1</span><span class="o">:</span><span class="n">n</span><span class="p">]</span>
       <span class="n">esc</span><span class="p">(</span><span class="kt">Expr</span><span class="p">(</span><span class="o">:</span><span class="n">block</span><span class="p">,</span>  <span class="n">defs</span><span class="o">...</span><span class="p">,</span> <span class="nb">nothing</span><span class="p">))</span>
     <span class="k">end</span>

<span class="nd">@gen_var</span> <span class="p">(</span><span class="k">macro</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">method</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">2</span>
<span class="n">f</span> <span class="p">(</span><span class="n">generic</span> <span class="k">function</span> <span class="n">with</span> <span class="mi">1</span> <span class="n">method</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="nd">@gen_var</span> <span class="n">f</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">var1</span>
<span class="mi">8</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">var2</span>
<span class="mi">18</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">var3</span>
<span class="mi">28</span>
</pre></div>
</div>
<div class="section" id="macro-function-from-ast-to-ast">
<h3>Macro, Function from AST to AST<a class="headerlink" href="#macro-function-from-ast-to-ast" title="Permalink to this headline">¶</a></h3>
<p>Once you know macros are functions from ASTs to ASTs, there’s no mystery to Julia macros.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="k">macro</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="n">println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="o">:</span><span class="p">(</span><span class="o">$</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>

<span class="nd">@assert</span> <span class="p">(</span><span class="nd">@f</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Above snippet shows a vivid example of Julia macros. Firstly <code class="docutils literal notranslate"><span class="pre">macro</span></code> keyword leads a definition of
macro transformation rule, and <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code> marks a callsite of corresonding macro.</p>
<p>You might ask why <code class="docutils literal notranslate"><span class="pre">(&#64;f</span> <span class="pre">1)</span> <span class="pre">==</span> <span class="pre">2</span></code>, for the return of macro <code class="docutils literal notranslate"><span class="pre">f</span></code> is supposed to be an AST, it seems
a bit magic that it equals to an integer <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
<p>Pay attention to the expression <code class="docutils literal notranslate"><span class="pre">&#64;assert</span> <span class="pre">(&#64;f</span> <span class="pre">1)</span> <span class="pre">==</span> <span class="pre">2</span></code>. As the macro invocations are processed recursively
from the inside out, we should firstly process <code class="docutils literal notranslate"><span class="pre">&#64;f</span> <span class="pre">1</span></code>.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="o">:</span><span class="p">(</span><span class="o">$</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>         <span class="o">=&gt;</span>  <span class="o">:</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Above step also write to stdio, when executing the AST to AST function <code class="docutils literal notranslate"><span class="pre">f</span></code>, a.k.a macro <code class="docutils literal notranslate"><span class="pre">&#64;f</span></code>.</p>
<p>Next, as we has already got the output, an AST <code class="docutils literal notranslate"><span class="pre">:(1</span> <span class="pre">+</span> <span class="pre">1)</span></code>, imagine that we displace <code class="docutils literal notranslate"><span class="pre">&#64;f</span> <span class="pre">1</span></code> by it in the preceding codes,
which produces <code class="docutils literal notranslate"><span class="pre">&#64;assert</span> <span class="pre">$(:(1</span> <span class="pre">+</span> <span class="pre">1))</span> <span class="pre">==</span> <span class="pre">2</span></code>, simplify it, we’ll get <code class="docutils literal notranslate"><span class="pre">&#64;assert</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">1)</span> <span class="pre">==</span> <span class="pre">2</span></code>.</p>
<p>You might ask why not <code class="docutils literal notranslate"><span class="pre">&#64;assert</span> <span class="pre">:(1</span> <span class="pre">+</span> <span class="pre">1)</span> <span class="pre">==</span> <span class="pre">2</span></code>, good question, let’s dig into it.</p>
<p>Think that what you return from a macro invocation is always a runtime AST, it will not
be transformed into codes to compile, so that the macro becomes useless at all.</p>
<p>However, if we “unquote” the macro return</p>
<table border="1" class="colwidths-given docutils align-left" id="id1">
<caption><span class="caption-text"><em>Unquote</em> Rule</span><a class="headerlink" href="#id1" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Quoted</th>
<th class="head">Unquoted</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">:(:(1</span> <span class="pre">+</span> <span class="pre">1))</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">:(1</span> <span class="pre">+</span> <span class="pre">1)</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">:(1</span> <span class="pre">+</span> <span class="pre">1)</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">+</span> <span class="pre">1</span></code></td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">quote</span> <span class="pre">1</span> <span class="pre">+</span> <span class="pre">1</span> <span class="pre">end</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">+</span> <span class="pre">1</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">quote</span> <span class="pre">$x</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">end</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">&lt;x&gt;</span> <span class="pre">+</span> <span class="pre">x</span></code>, where <code class="docutils literal notranslate"><span class="pre">&lt;x&gt;</span></code> stands for some computated expression.</td>
</tr>
<tr class="row-even"><td><code class="docutils literal notranslate"><span class="pre">1</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">1</span></code></td>
</tr>
<tr class="row-odd"><td><code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
<td><code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code></td>
</tr>
</tbody>
</table>
<p>Above table unveils the rules of AST interpolations, and obviously there’s a law that
if we say an expression is quoted <code class="docutils literal notranslate"><span class="pre">N</span></code> times, it’ll be interpolated as an expression
quoted <code class="docutils literal notranslate"><span class="pre">max(0,</span> <span class="pre">N</span> <span class="pre">-</span> <span class="pre">1)</span></code> times.</p>
</div>
<div class="section" id="scope-of-macro-and-hygienic-macro">
<h3>Scope of Macro and Hygienic Macro<a class="headerlink" href="#scope-of-macro-and-hygienic-macro" title="Permalink to this headline">¶</a></h3>
<p>The scoping rules of macros are simple enough when you are under the point of view that
macros are functions from ASTs to ASTs.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">julia</span><span class="o">&gt;</span> <span class="k">module</span> <span class="n">A</span>
  <span class="n">var</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">macro</span> <span class="n">ma</span><span class="p">()</span>
    <span class="k">quote</span>
      <span class="n">var</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">var</span> <span class="o">=</span> <span class="mi">5555</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="n">A</span><span class="o">.</span><span class="nd">@ma</span>
<span class="mi">0</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="k">using</span> <span class="o">.</span><span class="n">A</span><span class="o">:</span> <span class="nd">@ma</span>

<span class="n">julia</span><span class="o">&gt;</span> <span class="nd">@ma</span>
<span class="mi">0</span>
</pre></div>
</div>
<p>The first I’d present here is, the expression a macro return is evaluated by
the module where the macro’s defined.</p>
<p>When a macro is expanding inside the local scope of a function, a concept called <em>hygiene</em> comes up
naturally.</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="k">macro</span> <span class="n">assign_y</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
   <span class="o">:</span><span class="p">(</span><span class="n">y</span> <span class="o">=</span> <span class="o">$</span><span class="n">x</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="nd">@assign_y</span> <span class="n">x</span>
  <span class="n">y</span>
<span class="k">end</span>

<span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>You might expect it works, but unfortunately it won’t and solely feed you with</p>
<div class="highlight-Julia notranslate"><div class="highlight"><pre><span></span><span class="n">ERROR</span><span class="o">:</span> <span class="kt">UndefVarError</span><span class="o">:</span> <span class="n">x</span> <span class="n">not</span> <span class="n">defined</span>
<span class="n">Stacktrace</span><span class="o">:</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">f</span><span class="p">(</span><span class="o">::</span><span class="kt">Int64</span><span class="p">)</span> <span class="n">at</span> <span class="o">./</span><span class="n">REPL</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">:</span><span class="mi">2</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span> <span class="n">at</span> <span class="n">none</span><span class="o">:</span><span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, thautwarm.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.9.<br/>
    </p>
  </div>
</footer>
  </body>
</html>